first_state = closed

init {
    get_mob_info x self x
    get_mob_info y self y
    get_mob_info z_closed self z
    set_var z_open $z_closed
    calculate z_open $z_open + 150
    set_flying true
    start_height_effect
}

script {
    closed {
        on_enter {
            set_animation closed
            set_can_block_paths true
        }
        on_receive_message {
            get_event_info m message
            if $m = goal_reached
                set_state opening
            end_if
        }
    }

    opening {
        on_enter {
            set_animation rattling
            set_can_block_paths true
            move_to_absolute $x $y $z_open
            start_particles falling_dirt 0 0 0
        }
        on_receive_message {
            get_event_info m message
            if $m = goal_lost
                set_state closing
            end_if
        }
        on_reach_destination {
            set_state open
        }
    }
    
    open {
        on_enter {
            set_animation open
            set_can_block_paths false
            stop_particles
        }
        on_receive_message {
            get_event_info m message
            if $m = goal_lost
                set_state closing
            end_if
        }
    }

    closing {
        on_enter {
            set_animation rattling
            set_can_block_paths true
            move_to_absolute $x $y $z_closed
            start_particles falling_dirt 0 0 0
        }
        on_receive_message {
            get_event_info m message
            if $m = goal_reached
                set_state opening
            end_if
        }
        on_reach_destination {
            stop_particles
            start_particles dust_explosion_gate 0 0 0
            set_state closed
        }
    }
}
